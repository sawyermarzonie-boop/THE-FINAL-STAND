<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hatsune Miku Minesweeper</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    height: 100%;
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    background: #000;
    overflow: hidden;
  }

  /* Video background */
  #video-bg {
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: -1;
  }

  /* Main container */
  #main-container {
    background: rgba(0,0,0,0.75);
    padding: 20px 30px;
    border-radius: 12px;
    width: 90%;
    max-width: 1000px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 25px;
    color: #fff;
    overflow: hidden;
  }

  .ui-panel {
    width: 100%;
    text-align: center;
  }

  select, button {
    margin-top: 8px;
  }

  /* Grid for Minesweeper */
  #minesweeper table {
    display: grid;
    grid-template-columns: repeat(var(--cols), 1fr);
    grid-gap: 2px;
    width: 100%;
    max-height: 70vh;
    table-layout: fixed;
  }

  #minesweeper td {
    aspect-ratio: 1;
    background: #999;
    border: 1px solid #555;
    cursor: pointer;
    font-size: 1.2em;
    font-weight: bold;
    text-align: center;
    user-select: none;
  }

  td.revealed { background: #ccc; cursor: default; }
  td.flag { background: orange; }

  /* Confetti canvas */
  #confetti {
    position: fixed;
    top:0; left:0;
    width:100vw; height:100vh;
    pointer-events:none;
    z-index:20;
    display:none;
  }

</style>
</head>
<body>

<!-- Video Background -->
<video id="video-bg" autoplay loop muted playsinline>
  <source src="miku.mp4" type="video/mp4">
  Your browser doesnâ€™t support video.
</video>

<!-- Main Container -->
<div id="main-container">

  <div class="ui-panel">
    <h2>Hatsune Miku Minesweeper</h2>
    <label><input type="checkbox" id="music-toggle" checked> Music</label><br>
    <label><input type="checkbox" id="video-toggle" checked> Video</label><br><br>
    <label>Difficulty:
      <select id="diff">
        <option value="easy">Easy (5Ã—5, 5 mines)</option>
        <option value="medium">Medium (8Ã—8, 12 mines)</option>
        <option value="hard">Hard (10Ã—10, 20 mines)</option>
      </select>
    </label><br>
    <button onclick="startGame()">Restart Game</button>
    <div id="mine-count"></div>
  </div>

  <div class="ui-panel" id="minesweeper"></div>

</div>

<!-- Confetti canvas -->
<canvas id="confetti"></canvas>

<!-- Background Music -->
<audio id="bgmusic" loop>
  <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
</audio>

<script>
// ======== Minesweeper Logic ========
let rows, cols, mines, board, revealed, flags;

// Set difficulty
function setDifficulty(d) {
  if (d==="easy") { rows=5; cols=5; mines=5; }
  else if (d==="medium") { rows=8; cols=8; mines=12; }
  else { rows=10; cols=10; mines=20; }
}

// Start Game
function startGame() {
  setDifficulty(document.getElementById("diff").value);
  flags = 0;
  initMinesweeper();
  updateMineCount();
}

// Update mine counter
function updateMineCount() {
  document.getElementById("mine-count").innerText = `Mines: ${mines - flags}`;
}

// Initialize Minesweeper board
function initMinesweeper() {
  const container = document.getElementById("minesweeper");
  container.innerHTML = "";
  container.style.setProperty('--cols', cols);

  board = Array(rows).fill().map(()=>Array(cols).fill(0));
  revealed = Array(rows).fill().map(()=>Array(cols).fill(false));

  // Place mines
  let placed = 0;
  while (placed < mines) {
    let r = Math.floor(Math.random()*rows);
    let c = Math.floor(Math.random()*cols);
    if (board[r][c] !== "M") { board[r][c] = "M"; placed++; }
  }

  // Count neighbors
  for (let r=0;r<rows;r++){
    for (let c=0;c<cols;c++){
      if (board[r][c] !== "M") {
        let count = 0;
        for (let dr=-1;dr<=1;dr++){
          for (let dc=-1;dc<=1;dc++){
            let nr = r+dr, nc = c+dc;
            if (nr>=0 && nr<rows && nc>=0 && nc<cols && board[nr][nc]==="M") count++;
          }
        }
        board[r][c] = count;
      }
    }
  }

  // Render grid
  const table = document.createElement("table");
  table.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
  for (let r=0;r<rows;r++){
    for (let c=0;c<cols;c++){
      const td = document.createElement("td");
      td.dataset.r = r;
      td.dataset.c = c;
      td.oncontextmenu = e => { e.preventDefault(); toggleFlag(td); };
      td.onclick = () => revealCell(td);
      table.appendChild(td);
    }
  }
  container.appendChild(table);
}

// Flag toggle
function toggleFlag(td) {
  let r = +td.dataset.r, c = +td.dataset.c;
  if (revealed[r][c]) return;
  td.classList.toggle("flag");
  flags += td.classList.contains("flag") ? 1 : -1;
  updateMineCount();
}

// Reveal cell
function revealCell(td) {
  let r = +td.dataset.r, c = +td.dataset.c;
  if (td.classList.contains("flag") || revealed[r][c]) return;
  revealed[r][c] = true;
  td.classList.add("revealed");

  if (board[r][c] === "M") {
    alert("Boom! ðŸ’¥");
    startGame();
    return;
  }

  if (board[r][c] > 0) td.innerText = board[r][c];
  else {
    // Reveal neighbors recursively
    for (let dr=-1;dr<=1;dr++){
      for (let dc=-1;dc<=1;dc++){
        let nr = r+dr, nc = c+dc;
        if (nr>=0 && nr<rows && nc>=0 && nc<cols && !revealed[nr][nc]){
          const nxt=document.querySelector(`td[data-r='${nr}'][data-c='${nc}']`);
          revealCell(nxt);
        }
      }
    }
  }

  checkWin();
}

// Check win
function checkWin() {
  let safeCells = 0;
  for (let r=0;r<rows;r++){
    for (let c=0;c<cols;c++){
      if (!revealed[r][c] && board[r][c]!=="M") safeCells++;
    }
  }
  if (safeCells === 0) {
    startConfetti();
    setTimeout(startGame, 3000);
  }
}

// ======== Confetti Logic ========
const confettiCanvas = document.getElementById("confetti");
const confettiCtx = confettiCanvas.getContext("2d");
confettiCanvas.width = window.innerWidth;
confettiCanvas.height = window.innerHeight;
let confettiParticles = [];

function createConfetti() {
  confettiParticles = [];
  for (let i=0;i<150;i++){
    confettiParticles.push({
      x: Math.random()*confettiCanvas.width,
      y: Math.random()*confettiCanvas.height - confettiCanvas.height,
      r: Math.random()*6+4,
      d: Math.random()*150+50,
      color: `hsl(${Math.random()*360}, 100%, 50%)`,
      tilt: Math.random()*10-10
    });
  }
}

function drawConfetti() {
  confettiCtx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
  confettiParticles.forEach(p=>{
    confettiCtx.beginPath();
    confettiCtx.lineWidth = p.r/2;
    confettiCtx.strokeStyle = p.color;
    confettiCtx.moveTo(p.x + p.tilt + p.r/4, p.y);
    confettiCtx.lineTo(p.x + p.tilt, p.y + p.tilt + p.r/4);
    confettiCtx.stroke();
    p.y += 2;
    if (p.y>confettiCanvas.height) p.y=-10;
  });
}

function startConfetti() {
  confettiCanvas.style.display = "block";
  createConfetti();
  let interval = setInterval(drawConfetti, 20);
  setTimeout(()=>{
    clearInterval(interval);
    confettiCtx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
    confettiCanvas.style.display = "none";
  }, 4000);
}

// ======== Initial Setup ========
startGame();

// ======== Music & Video Toggles ========
document.getElementById("music-toggle").addEventListener("change", e=>{
  const music=document.getElementById("bgmusic");
  if (e.target.checked) music.play();
  else music.pause();
});

document.getElementById("video-toggle").addEventListener("change", e=>{
  document.getElementById("video-bg").style.display = e.target.checked ? "block" : "none";
});

// ======== Resize confetti canvas ========
window.addEventListener('resize', ()=>{
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;
});
</script>

</body>
</html>

